<!DOCTYPE html>
<html lang="uz">

<head>

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
  <style>
    .swiper {
      width: 100%;
      height: 100%;
    }

    .swiper-pagination-bullet {
      background: #fff;
      opacity: 0.5;
    }

    .swiper-pagination-bullet-active {
      opacity: 1;
      background: #fff;
    }
  </style>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mahsulotlar</title>

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link
    href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800;900&family=Outfit:wght@400;500;600;700;800;900&family=Playfair+Display:wght@400;500;600;700;800;900&family=JetBrains+Mono:wght@400;500;600;700;800&display=swap"
    rel="stylesheet" />

  <!-- Tailwind v3 CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Iconify -->
  <script src="https://code.iconify.design/iconify-icon/3.0.0/iconify-icon.min.js"></script>

  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            background: 'var(--background)',
            foreground: 'var(--foreground)',
            card: { DEFAULT: 'var(--card)', foreground: 'var(--card-foreground)' },
            primary: { DEFAULT: 'var(--primary)', foreground: 'var(--primary-foreground)' },
            secondary: { DEFAULT: 'var(--secondary)', foreground: 'var(--secondary-foreground)' },
            muted: { DEFAULT: 'var(--muted)', foreground: 'var(--muted-foreground)' },
            accent: { DEFAULT: 'var(--accent)', foreground: 'var(--accent-foreground)' },
            destructive: { DEFAULT: 'var(--destructive)', foreground: '#ffffff' },
            border: 'var(--border)',
            input: 'var(--input)',
            ring: 'var(--ring)',
          },
          fontFamily: {
            sans: ['var(--font-sans)', 'system-ui', 'sans-serif'],
            heading: ['var(--font-heading)', 'system-ui', 'sans-serif'],
            serif: ['var(--font-serif)', 'Georgia', 'serif'],
            mono: ['var(--font-mono)', 'monospace'],
          },
          borderRadius: {
            lg: 'var(--radius)',
            xl: 'calc(var(--radius) + 4px)',
            '2xl': 'calc(var(--radius) + 8px)',
            '3xl': 'calc(var(--radius) + 12px)',
          },
        },
      },
    };
  </script>

  <style>
    :root {
      --background: #ffffff;
      --foreground: #1a1a1a;

      --card: #ffffff;
      --card-foreground: #1a1a1a;

      --primary: #1a1a1a;
      --primary-foreground: #ffffff;

      --secondary: #f4f4f5;
      --secondary-foreground: #1a1a1a;

      --muted: #f4f4f5;
      --muted-foreground: #737373;

      --accent: #d4af37;
      --accent-foreground: #ffffff;

      --destructive: #ef4444;

      --border: #e5e5e5;
      --input: #e5e5e5;
      --ring: #1a1a1a;

      --radius: 16px;

      --font-sans: "Plus Jakarta Sans", system-ui, sans-serif;
      --font-heading: "Outfit", system-ui, sans-serif;
      --font-serif: "Playfair Display", Georgia, serif;
      --font-mono: "JetBrains Mono", monospace;
    }

    body {
      font-family: var(--font-sans);
      background-color: var(--background);
      color: var(--foreground);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      margin: 0;
    }

    .pb-safe {
      padding-bottom: env(safe-area-inset-bottom, 0px);
    }

    /* select ko‘rinishi chiroyli bo‘lsin */
    select {
      appearance: none;
      -webkit-appearance: none;
      -moz-appearance: none;
    }
  </style>
</head>

<body>
  <div
    class="bg-background min-h-screen font-sans text-foreground relative pb-32 overflow-x-hidden selection:bg-primary/20">

    <!-- Header -->
    <header
      class="sticky top-0 z-40 bg-background/90 backdrop-blur-xl border-b border-border/30 px-6 py-5 flex justify-center items-center">
      <div class="relative w-full flex justify-center items-center max-w-5xl">
        <button class="absolute left-0 p-2 text-foreground/80 hover:text-foreground" type="button" aria-label="Menu">
          <iconify-icon icon="lucide:menu" width="24" height="24"></iconify-icon>
        </button>

        <h1 class="text-2xl font-black tracking-[0.25em] text-foreground">NONIK</h1>

        <button class="absolute right-0 p-2 text-foreground/80 hover:text-foreground" type="button"
          aria-label="Notification">
          <iconify-icon icon="lucide:bell" width="24" height="24"></iconify-icon>
        </button>
      </div>
    </header>

    <!-- Filter Panel -->
    <section class="px-4 py-6">
      <div
        class="max-w-5xl mx-auto bg-card rounded-[24px] shadow-[0_8px_40px_-12px_rgba(0,0,0,0.08)] border border-border/40 p-5 space-y-5">

        <form class="filterform space-y-5" method="GET" action="/">
          <!-- Search -->
          <div class="relative group">
            <div
              class="absolute left-4 top-1/2 -translate-y-1/2 text-muted-foreground group-focus-within:text-primary transition-colors">
              <iconify-icon icon="lucide:search" width="20" height="20"></iconify-icon>
            </div>

            <input type="text" name="q" value="<%= filters?.q || '' %>" placeholder="Qidirish..." class="w-full h-12 pl-11 pr-4 bg-secondary/40 border border-transparent rounded-xl text-sm font-medium
                     focus:outline-none focus:bg-background focus:border-primary/20 focus:ring-4 focus:ring-primary/5 transition-all
                     placeholder:text-muted-foreground/60 text-foreground" />
          </div>

          <!-- Tag + Sort -->
          <div class="flex gap-3">
            <div class="relative flex-1">
              <select name="tag"
                class="w-full h-12 px-4 bg-background border border-border rounded-xl text-xs font-semibold text-foreground
                       hover:border-primary/30 transition-colors focus:outline-none focus:ring-4 focus:ring-primary/5 pr-10">
                <option value="ALL" <%=(filters?.tag==='ALL' ) ? 'selected' : '' %>>Teg: Barchasi</option>
                <% (productTagsEnum || []).forEach(function(t){ %>
                  <option value="<%= t %>" <%=(filters?.tag===t) ? 'selected' : '' %>>
                    Teg: <%= productTagLabels?.[t] || t %>
                  </option>
                  <% }) %>
              </select>

              <div class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground">
                <iconify-icon icon="lucide:chevron-down" width="18" height="18"></iconify-icon>
              </div>
            </div>

            <div class="relative flex-1">
              <select name="sort"
                class="w-full h-12 px-4 bg-background border border-border rounded-xl text-xs font-semibold text-foreground
                       hover:border-primary/30 transition-colors focus:outline-none focus:ring-4 focus:ring-primary/5 pr-10">
                <option value="newest" <%=(filters?.sort==='newest' ) ? 'selected' : '' %>>Saralash: Eng yangi</option>
                <option value="oldest" <%=(filters?.sort==='oldest' ) ? 'selected' : '' %>>Saralash: Eng eski</option>
                <option value="price_asc" <%=(filters?.sort==='price_asc' ) ? 'selected' : '' %>>Saralash: Narx (↑)
                </option>
                <option value="price_desc" <%=(filters?.sort==='price_desc' ) ? 'selected' : '' %>>Saralash: Narx (↓)
                </option>
                <option value="name_asc" <%=(filters?.sort==='name_asc' ) ? 'selected' : '' %>>Saralash: Nom (A→Z)
                </option>
                <option value="name_desc" <%=(filters?.sort==='name_desc' ) ? 'selected' : '' %>>Saralash: Nom (Z→A)
                </option>
              </select>

              <div class="pointer-events-none absolute right-3 top-1/2 -translate-y-1/2 text-muted-foreground">
                <iconify-icon icon="lucide:chevron-down" width="18" height="18"></iconify-icon>
              </div>
            </div>
          </div>

          <!-- Clear -->
          <button id="clearFilters" type="button" class="w-full h-12 border border-dashed border-border rounded-xl flex items-center justify-center gap-2 text-xs font-bold
                   tracking-widest text-muted-foreground hover:text-foreground hover:border-foreground/30 hover:bg-secondary/30
                   transition-all uppercase">
            <iconify-icon icon="lucide:x" width="14" height="14"></iconify-icon>
            Tozalash
          </button>

          <!-- Count -->
          <div class="text-xs text-muted-foreground font-semibold tracking-wide px-1">
            <span id="countNote">
              <%= products?.length || 0 %> ta mahsulot
            </span>
          </div>
        </form>
      </div>
    </section>

    <!-- Product Grid -->
    <main class="px-4">
      <div class="max-w-5xl mx-auto">
        <div id="cardsWrap" class="grid grid-cols-2 gap-x-4 gap-y-8">
  <% if (products && products.length) { %>
    <% 
       // Narxni 175 000 ko'rinishida chiqarish uchun funksiya
       const formatPrice = (n) => new Intl.NumberFormat('fr-FR').format(n); 
    %>
    <% products.forEach(function(p){ %>
      <article class="pCard flex flex-col group">
        <div class="relative aspect-[4/5] w-full bg-secondary rounded-[20px] overflow-hidden mb-3">
          <div class="swiper mySwiper-<%= p._id %> h-full w-full">
            <div class="swiper-wrapper">
              <% if (p.productImages && p.productImages.length) { %>
                <% p.productImages.forEach(function(imgSrc){ 
                  const src = imgSrc.startsWith('http') ? imgSrc : (imgSrc.startsWith('/') ? imgSrc : '/' + imgSrc); 
                %>
                  <div class="swiper-slide">
                    <img class="object-cover w-full h-full" src="<%= src %>" alt="<%= p.productName %>" />
                  </div>
                <% }) %>
              <% } else { %>
                <div class="swiper-slide flex items-center justify-center text-muted-foreground text-xs">Rasm yo‘q</div>
              <% } %>
            </div>
            <% if (p.productImages && p.productImages.length > 1) { %>
              <div class="swiper-pagination"></div>
            <% } %>
          </div>

          <button class="absolute top-3 right-3 z-10 w-9 h-9 rounded-full bg-background/80 backdrop-blur-sm text-foreground flex items-center justify-center shadow-sm hover:bg-background hover:scale-110 transition-all active:scale-95" type="button">
            <iconify-icon icon="lucide:heart" width="18" height="18"></iconify-icon>
          </button>

          <% if (p.productDiscountPercent) { %>
            <div class="absolute top-3 left-3 z-10 px-2 py-1 bg-destructive/90 backdrop-blur-sm rounded-lg">
              <span class="text-[10px] font-bold text-white uppercase tracking-wider">-<%= p.productDiscountPercent %>%</span>
            </div>
          <% } %>
        </div>

        <div class="space-y-1.5 px-1 flex-1 flex flex-col">
          <h3 class="text-sm font-bold text-foreground leading-tight line-clamp-2 min-h-[2.5rem]">
            <%= p.productName %>
          </h3>

          <p class="text-xs text-muted-foreground truncate">
            <%= p.productDesc || 'Sifatli mahsulot' %>
          </p>

          <div class="pt-2 mt-auto flex flex-col gap-3">
            <div class="flex items-center gap-2 flex-wrap">
              <span class="text-base font-black text-foreground">
                <%= formatPrice(p.productPrice) %> so‘m
              </span>

              <% if (p.productOldPrice && p.productOldPrice > p.productPrice) { %>
                <span class="text-[11px] text-muted-foreground line-through font-semibold">
                  <%= formatPrice(p.productOldPrice) %>
                </span>
              <% } %>
            </div>

            <button class="w-full h-10 bg-primary text-primary-foreground text-xs font-bold rounded-xl flex items-center justify-center gap-2 hover:bg-primary/90 active:scale-95 transition-all shadow-lg shadow-primary/20" type="button">
              <iconify-icon icon="lucide:shopping-bag" width="14" height="14"></iconify-icon>
              Savatga
            </button>
          </div>
        </div>
      </article>
    <% }) %>
  <% } else { %>
    <div class="col-span-2 text-center py-10 text-sm text-muted-foreground empty">
      Hech narsa topilmadi.
    </div>
  <% } %>
</div>

        <!-- Pagination (Prev/Next only) -->
        <div id="pager" class="mt-8 mb-4 px-2 flex justify-between items-center" hidden>
          <button id="pgPrev" type="button"
            class="h-10 px-4 rounded-xl border border-border text-xs font-semibold text-muted-foreground hover:text-foreground hover:border-foreground transition-all flex items-center gap-1 group">
            <iconify-icon icon="lucide:arrow-left"
              class="group-hover:-translate-x-1 transition-transform"></iconify-icon>
            Oldingi
          </button>

          <div class="text-xs font-semibold text-muted-foreground px-3">
            8 tadan ko‘rsatish
          </div>

          <button id="pgNext" type="button"
            class="h-10 px-4 rounded-xl border border-border text-xs font-semibold text-muted-foreground hover:text-foreground hover:border-foreground transition-all flex items-center gap-1 group">
            Keyingi
            <iconify-icon icon="lucide:arrow-right"
              class="group-hover:translate-x-1 transition-transform"></iconify-icon>
          </button>
        </div>
      </div>
    </main>

    <!-- Bottom Navigation (ixtiyoriy) -->
    <nav
      class="fixed bottom-0 left-0 right-0 z-50 bg-background/80 backdrop-blur-xl border-t border-border/30 pb-safe pt-2">
      <div class="max-w-5xl mx-auto flex justify-around items-center h-[60px] px-2">
        <button class="flex flex-col items-center justify-center gap-1 w-full h-full text-primary group" type="button">
          <div class="relative p-1.5 rounded-xl bg-primary/5 group-hover:bg-primary/10 transition-colors">
            <iconify-icon icon="lucide:store" width="24" height="24" class="stroke-[2.5px]"></iconify-icon>
          </div>
          <span class="text-[10px] font-bold">Shop</span>
        </button>

        <button
          class="flex flex-col items-center justify-center gap-1 w-full h-full text-muted-foreground hover:text-foreground transition-colors group"
          type="button">
          <div class="relative p-1.5 rounded-xl group-hover:bg-secondary transition-colors">
            <iconify-icon icon="lucide:search" width="24" height="24" class="stroke-[2px]"></iconify-icon>
          </div>
          <span class="text-[10px] font-medium">Search</span>
        </button>

        <button
          class="flex flex-col items-center justify-center gap-1 w-full h-full text-muted-foreground hover:text-foreground transition-colors group"
          type="button">
          <div class="relative p-1.5 rounded-xl group-hover:bg-secondary transition-colors">
            <iconify-icon icon="lucide:shopping-bag" width="24" height="24" class="stroke-[2px]"></iconify-icon>
            <span class="absolute top-1 right-1 w-2 h-2 bg-destructive rounded-full"></span>
          </div>
          <span class="text-[10px] font-medium">Savat</span>
        </button>

        <button
          class="flex flex-col items-center justify-center gap-1 w-full h-full text-muted-foreground hover:text-foreground transition-colors group"
          type="button">
          <div class="relative p-1.5 rounded-xl group-hover:bg-secondary transition-colors">
            <iconify-icon icon="lucide:user" width="24" height="24" class="stroke-[2px]"></iconify-icon>
          </div>
          <span class="text-[10px] font-medium">Profile</span>
        </button>
      </div>
      <div class="h-[20px]"></div>
    </nav>

  </div>

  <script src="/js/public-products.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
<script>
  function initSwipers() {
    document.querySelectorAll('.swiper').forEach(el => {
      new Swiper(el, {
        pagination: {
          el: el.querySelector('.swiper-pagination'),
          clickable: true,
        },
        loop: el.querySelectorAll('.swiper-slide').length > 1,
      });
    });
  }
  
  // Sahifa yuklanganda ishga tushadi
  document.addEventListener('DOMContentLoaded', initSwipers);
  
  // AJAX orqali mahsulotlar yangilanganda ham qayta ishga tushirish kerak
  // Sizning ajaxRefresh funksiyangiz oxirida initSwipers() ni chaqirib qo'ying
</script>
</body>

</html>